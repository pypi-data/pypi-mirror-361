cd /Users/les/Projects/starlette-async-jinja && python -m pytest -vv tests/test_responses.py
direnv: loading ~/Projects/starlette-async-jinja/.envrc                         
direnv: export +PDM_ACTIVE ~PATH
(starlette-async-jinja) [starlette-async-jinja] cd /Users/les/Projects/starlette-async-jinja && python -m pytest -vv tests/test_responses.py
============================= test session starts ==============================
platform darwin -- Python 3.13.3, pytest-8.3.5, pluggy-1.5.0 -- /Users/les/Projects/starlette-async-jinja/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/les/Projects/starlette-async-jinja
configfile: pyproject.toml
plugins: anyio-4.9.0, timeout-2.4.0, asyncio-0.26.0, mock-3.14.0, cov-6.1.1
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collected 34 items                                                             

tests/test_responses.py::test_json_response_render PASSED                [  2%]
tests/test_responses.py::test_template_response_init PASSED              [  5%]
tests/test_responses.py::test_template_response_call_with_debug_extension PASSED [  8%]
tests/test_responses.py::test_async_jinja2_templates_init PASSED         [ 11%]
tests/test_responses.py::test_async_jinja2_templates_init_with_options PASSED [ 14%]
tests/test_responses.py::test_async_jinja2_templates_create_env PASSED   [ 17%]
tests/test_responses.py::test_async_jinja2_templates_render_block PASSED [ 20%]
tests/test_responses.py::test_async_jinja2_templates_generate_render_partial PASSED [ 23%]
tests/test_responses.py::test_async_jinja2_templates_renderer PASSED     [ 26%]
tests/test_responses.py::test_async_jinja2_templates_render_fragment PASSED [ 29%]
tests/test_responses.py::test_async_jinja2_templates_render_fragment_with_context PASSED [ 32%]
tests/test_responses.py::test_async_jinja2_templates_render_fragment_block_not_found PASSED [ 35%]
tests/test_responses.py::test_async_jinja2_templates_get_template PASSED [ 38%]
tests/test_responses.py::test_async_jinja2_templates_get_template_not_found PASSED [ 41%]
tests/test_responses.py::test_async_jinja2_templates_template_response PASSED [ 44%]
tests/test_responses.py::test_async_jinja2_templates_template_response_kwargs PASSED [ 47%]
tests/test_responses.py::test_async_jinja2_templates_template_response_context_processors PASSED [ 50%]
tests/test_responses.py::test_async_jinja2_templates_template_response_other_args PASSED [ 52%]
tests/test_responses.py::test_render_template_alias PASSED               [ 55%]
tests/test_responses.py::test_render_block_error_handling PASSED         [ 58%]
tests/test_responses.py::test_template_response_with_none_context PASSED [ 61%]
tests/test_responses.py::test_async_jinja2_templates_renderer_error_handling PASSED [ 64%]
tests/test_responses.py::test_async_jinja2_templates_render_fragment_exception_handling FAILED [ 67%]
tests/test_responses.py::test_async_jinja2_templates_template_response_error_handling PASSED [ 70%]
tests/test_responses.py::test_async_jinja2_templates_render_block_no_markup PASSED [ 73%]
tests/test_responses.py::test_json_response_render_parametrized[data0-{"key":"value"}] PASSED [ 76%]
tests/test_responses.py::test_json_response_render_parametrized[data1-{"nested":{"key":["value1","value2"]}}] PASSED [ 79%]
tests/test_responses.py::test_json_response_render_parametrized[data2-[]] PASSED [ 82%]
tests/test_responses.py::test_json_response_render_parametrized[data3-{}] PASSED [ 85%]
tests/test_responses.py::test_json_response_render_parametrized[None-null] PASSED [ 88%]
tests/test_responses.py::test_json_response_render_parametrized[123-123] PASSED [ 91%]
tests/test_responses.py::test_json_response_render_parametrized[string-"string"] PASSED [ 94%]
tests/test_responses.py::test_json_response_render_parametrized[True-true] PASSED [ 97%]
tests/test_responses.py::test_async_jinja2_templates_render_fragment_handle_exception FAILED [100%]

=================================== FAILURES ===================================
________ test_async_jinja2_templates_render_fragment_exception_handling ________

templates = <starlette_async_jinja.responses.AsyncJinja2Templates object at 0x10db15090>
template_dir = Path('/private/var/folders/kb/k4k33dq55xg_hms12z4db1vw0000gn/T/pytest-of-les/pytest-4/test_async_jinja2_templates_re6/templates')
mock_template = <MagicMock spec='Template' id='4523878992'>

    @pytest.mark.asyncio
    async def test_async_jinja2_templates_render_fragment_exception_handling(
        templates: AsyncJinja2Templates, template_dir: AsyncPath, mock_template: MagicMock
    ) -> None:
        with patch.object(
            templates, "get_template_async", AsyncMock(return_value=mock_template)
        ):
            with patch.object(
                mock_template.blocks["my_block"], "__call__", side_effect=Exception("Block rendering error")
            ):
>               with pytest.raises(RuntimeError) as exc_info:
E               Failed: DID NOT RAISE <class 'RuntimeError'>

tests/test_responses.py:425: Failed
_________ test_async_jinja2_templates_render_fragment_handle_exception _________

templates = <starlette_async_jinja.responses.AsyncJinja2Templates object at 0x10daf3550>
template_dir = Path('/private/var/folders/kb/k4k33dq55xg_hms12z4db1vw0000gn/T/pytest-of-les/pytest-4/test_async_jinja2_templates_re8/templates')
mock_template = <MagicMock spec='Template' id='4524763056'>

    @pytest.mark.asyncio
    async def test_async_jinja2_templates_render_fragment_handle_exception(
        templates: AsyncJinja2Templates, template_dir: AsyncPath, mock_template: MagicMock
    ) -> None:
        with patch.object(
            templates, "get_template_async", AsyncMock(return_value=mock_template)
        ):
            with patch.object(
                mock_template.blocks["my_block"], "__call__", side_effect=Exception("Block rendering error")
            ):
                with patch.object(templates.env, "handle_exception", return_value="Error handled"):
                    result = await templates.render_fragment("test.html", "my_block")
>                   assert result == "Error handled"
E                   AssertionError: assert '' == 'Error handled'
E                     
E                     - Error handled

tests/test_responses.py:486: AssertionError
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.13.3-final-0 _______________

Name                                 Stmts   Miss  Cover
--------------------------------------------------------
starlette_async_jinja/responses.py     115      4    97%
--------------------------------------------------------
TOTAL                                  115      4    97%
=========================== short test summary info ============================
FAILED tests/test_responses.py::test_async_jinja2_templates_render_fragment_exception_handling - Failed: DID NOT RAISE <class 'RuntimeError'>
FAILED tests/test_responses.py::test_async_jinja2_templates_render_fragment_handle_exception - AssertionError: assert '' == 'Error handled'
  
  - Error handled
========================= 2 failed, 32 passed in 0.98s =========================
(starlette-async-jinja) [starlette-async-jinja]                       main  ✭ ✱
