# MCP 응답 지침 (instructions.md)

이 문서는 AI/에이전트(LLM 등)가 `pg-mcp-server-beta` 내 문서를 검색하거나 안내할 때 반드시 따라야 할 행동 원칙을 정의합니다.  
모든 응답은 **실제 MCP Tool 호출 결과를 기반으로만** 생성되어야 하며, 문서에 없는 내용을 추측하거나 임의로 생성해서는 안 됩니다.

> 최종 수정일: 2024-07-X8

---

## 📌 1. 응답 기본 원칙

- **반드시 MCP Tool(`list_docs`, `search_docs`, `get_docs`)을 사용하여 최신 문서 상태를 확인하고, 응답을 구성한다.**
- **모든 사용자 질문에 대해 반드시 문서 검색 도구(키워드 기반 검색, 예: search_docs)를 먼저 실행하고, 검색 결과(문서 청크)를 기반으로 답변을 작성한다.**
- **검색 결과가 여러 개일 경우, 관련성이 높은 순서대로 안내한다.**
- **문서 원문에서 직접 인용한 내용만 응답한다.**
  - 예시 코드, 파라미터 표, API URI 등도 모두 문서에서 직접 발췌해야 함.
- **문서에 없는 정보는 생성하지 않는다.**
  - 반드시 다음과 같이 안내: `"문서에 해당 내용이 없습니다."`

---

## 📁 2. 문서 식별 방법

- 문서는 다음 중 하나로 식별 가능:
  - 숫자 ID (예: `"1"`)
  - 파일 경로 (예: `"pg/hecto_financial_pg.md"`)

- 예시:
```python
get_docs(doc_id="1")
get_docs(doc_id="pg/hecto_financial_pg.md")
```

---

## 🔍 3. 검색 응답 정책 (`search_docs`)

- **검색은 헤더(섹션) 단위로 분할된 청크(chunk) 기준으로 반환**
- **BM25 점수 및 헤딩 가중치(헤딩에 검색어 포함 시 1.5배 등)를 곱해 상위 노출**
- **헤딩 계층(모든 heading level, h1~h6 등)을 context_stack에 계층적으로 쌓아, 실제 문서 계층이 정확히 반영됨**
- **중복 청크(본문) 필터링: 본문이 완전히 동일한 청크는 하나만 노출(set 활용)**
- **카테고리 자동 매핑/우선 노출:**
  - 검색어에 카테고리명이 포함되면 해당 카테고리 결과를 우선 상위에 노출
  - 카테고리명과 검색어 모두 소문자+공백제거로 정규화하여 하드코딩 없이 동적 매핑
- **카테고리 파라미터(category) 지원:**
  - 단일(str), 다중(list), 미지정(None) 모두 허용
  - 사용 가능한 카테고리: `"PG"`, `"내통장결제"`, `"간편현금결제"`
  - 미지정(None) 시 전체 문서에서 검색
  - 예시:
    - `search_docs(query="암호화", category="PG")` → PG 카테고리만 검색
    - `search_docs(query="암호화", category=["PG", "내통장결제"])` → PG, 내통장결제 모두 검색
    - `search_docs(query="암호화")` → 전체 문서에서 검색
- **검색어 전처리/번호형 헤딩 대응:**
  - 번호형 헤딩(예: `## 17. 이중 로그인`)에서 번호를 빼고 `"이중 로그인"`만 입력해도 해당 섹션이 검색됨
- **검색 결과 구조:**
  ```json
  {
    "검색어": ["카드", "계좌이체"],
    "검색결과": [
      {
        "문서제목": "내통장결제 소개",
        "문서ID": "1",
        "카테고리": "내통장결제",
        "본문": "[6. 결제인증 (UI) > 6.1 요약 설명]\n이 섹션은 ..."
      },
      ...
    ],
    "안내": "관련성이 높은 문서 섹션을 정렬하여 제공합니다."
  }
  ```
  - **본문** 맨 앞에 `[6. > 6.1 > ...]` 등 계층 경로가 포함됨
  - **태그는 포함되지 않음**
- **검색 결과가 없을 경우:**
  ```json
  { "안내": "'키워드'에 대한 검색 결과가 없습니다." }
  ```

---

## 📚 4. 문서 목록 응답 (`list_docs`)

- 전체 문서의 메타데이터를 포함한 목록 반환
- 정렬(sort), 필터(category), 페이징(page, page_size) 파라미터 지원
- 각 문서에 대해 다음 정보를 포함:
  ```json
  {
    "문서목록": [
      {
        "문서ID": "1",
        "제목": "카드 결제 연동",
        "카테고리": "PG",
        "파일명": "pg/hecto_financial_pg.md",
        "태그": ["카드", "결제"]
      },
      ...
    ],
    "안내": "문서 ID를 참고해 get_docs로 상세 내용을 확인할 수 있습니다."
  }
  ```

---

## 📄 5. 문서 원문 조회 (`get_docs`)

- 특정 문서의 전체 마크다운 원문을 반환
- ID 또는 파일명으로 조회 가능
- **LLM 입력 토큰 한계로 인해 전체 반환 시 일부만 요약/부분 반환될 수 있음**
  ```json
  {
    "문서ID": "pg/hecto_financial_pg.md",
    "제목": "카드 결제 연동",
    "카테고리": "PG",
    "파일명": "pg/hecto_financial_pg.md",
    "내용": "# 헥토 PG 연동 가이드\n...",
    "안내": "해당 문서의 전체 내용을 반환합니다."
  }
  ```
  - **태그는 포함되지 않음**

---

## ⚠️ 6. 오류 및 예외 응답

| 상황         | 예시 응답                                                         |
|--------------|-------------------------------------------------------------------|
| 검색어 없음  | `{ "안내": "검색어를 입력해 주세요. 예: '내통장 결제', ... " }`    |
| 문서 없음    | `{ "안내": "문서 ID 또는 경로에 해당하는 문서를 찾을 수 없습니다." }` |
| 예외 발생    | `{ "오류": "검색 중 문제가 발생했습니다: ..." }`                   |
| 내부 서버 오류 | `{ "오류": "내부 서버 오류가 발생했습니다. (500)" }`              |

---

## 🧷 7. 원문 인용 지침

- 예시 코드, 파라미터 표, API 명세, 설명 등은 문서 원문에서 **직접 발췌**하여 안내
- 새로 작성하거나 요약해서는 안 됨

---

## 🛠️ 8. 도구별 파라미터 및 사용 우선순위

| 도구명         | 주요 파라미터                                      | 설명                                 | 예시 호출 |
|----------------|---------------------------------------------------|--------------------------------------|------------|
| `list_docs`    | `sort_by`, `order`, `category`, `page`, `page_size` | 전체 문서 메타데이터 목록 반환         | `list_docs(page=1, page_size=10)` |
| `search_docs`  | `query: str`, `category: str|list|None`           | 키워드 및 카테고리 기반 검색           | `search_docs(query="카드", category=["PG", "내통장결제"])` |
| `get_docs`     | `doc_id: str`                                     | 문서 ID 또는 경로로 원문 조회          | `get_docs(doc_id="1")` |

| 상황                   | 사용 순서                                 |
|------------------------|-------------------------------------------|
| 문서명 또는 ID 모를 때 | `list_docs` → `search_docs` → `get_docs`  |
| 키워드 기반 검색       | `search_docs` → `get_docs`                |
| 파일명 또는 ID를 알 때 | `get_docs`                                |
| 연동 스크립트 등 추정  | `list_docs` → `get_docs`                  |

---
