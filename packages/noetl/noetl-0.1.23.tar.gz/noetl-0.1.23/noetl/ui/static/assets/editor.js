import"./main2.js";const h={playbook:{apiVersion:"noetl.io/v1",kind:"Playbook",name:"new-playbook",path:"",workload:{},workflow:[]},selectedNode:null,isUpdating:!1,monaco:null,workloadEditor:null,yamlEditor:null,reactFlow:{setNodes:()=>console.warn("ReactFlow not initialized."),setEdges:()=>console.warn("ReactFlow not initialized.")},async init(){console.log("Initializing EditorApp..."),this.initDOMListeners(),this.setupAntTabs();try{await this.loadMonacoEditor(),await this.loadReactFlow(),this.loadPlaybookFromURL()}catch(e){console.error("Initialization failed:",e),this.showInfoMessage(e.message,"error")}},initDOMListeners(){document.getElementById("save-playbook").addEventListener("click",()=>this.savePlaybook()),document.getElementById("execute-playbook").addEventListener("click",()=>this.executePlaybook()),document.getElementById("export-yaml").addEventListener("click",()=>this.exportYaml()),document.getElementById("import-yaml").addEventListener("click",()=>this.showImportModal()),document.getElementById("confirm-import").addEventListener("click",()=>this.importYaml()),document.getElementById("add-step").addEventListener("click",()=>this.addNode("step")),document.getElementById("add-task").addEventListener("click",()=>this.addNode("task")),document.querySelector("#info-panel .ant-alert-close-icon")?.addEventListener("click",()=>this.hideInfoMessage()),document.getElementById("properties-panel").addEventListener("click",t=>{t.target.matches('button[data-action="update-node"]')&&this.updateNodeProperties()})},loadMonacoEditor(){return new Promise((e,t)=>{if(window.monaco)return this.monaco=window.monaco,this.initMonacoInstances(),e();require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs"}}),require(["vs/editor/editor.main"],()=>{console.log("Monaco editor loaded via require"),this.monaco=window.monaco,this.initMonacoInstances(),e()},o=>{t(new Error("Failed to load Monaco Editor."))})})},initMonacoInstances(){this.workloadEditor=this.monaco.editor.create(document.getElementById("workload-editor"),{value:JSON.stringify(this.playbook.workload,null,2),language:"json",theme:"vs",automaticLayout:!0}),this.yamlEditor=this.monaco.editor.create(document.getElementById("yaml-editor"),{value:jsyaml.dump(this.playbook),language:"yaml",theme:"vs",automaticLayout:!0}),this.workloadEditor.onDidChangeModelContent(()=>this.syncFromWorkload()),this.yamlEditor.onDidChangeModelContent(()=>this.syncFromYaml())},loadReactFlow(){return new Promise((e,t)=>{const o=()=>{window.React&&window.ReactDOM&&window.ReactFlow?(console.log("ReactFlow and dependencies are ready."),this.initReactFlowInstance(),e()):Date.now()-a>1e4?t(new Error("Failed to load ReactFlow library within 10 seconds.")):setTimeout(o,100)},a=Date.now();o()})},initReactFlowInstance(){const e=document.getElementById("workflow-editor"),t=document.createElement("div");t.style.width="100%",t.style.height="100%",e.appendChild(t);const{ReactFlowProvider:o,Background:a,Controls:d,MiniMap:i,applyNodeChanges:n,applyEdgeChanges:l,addEdge:c}=window.ReactFlow;class p extends React.Component{constructor(r){super(r),this.state={nodes:[],edges:[]},h.reactFlow.setNodes=s=>this.setState(u=>({nodes:typeof s=="function"?s(u.nodes):s})),h.reactFlow.setEdges=s=>this.setState(u=>({edges:typeof s=="function"?s(u.edges):s}))}render(){return React.createElement(o,null,React.createElement(window.ReactFlow,{nodes:this.state.nodes,edges:this.state.edges,onNodesChange:r=>this.setState(s=>({nodes:n(r,s.nodes)})),onEdgesChange:r=>this.setState(s=>({edges:l(r,s.edges)})),onConnect:r=>this.setState(s=>({edges:c(r,s.edges)})),onNodeClick:(r,s)=>{h.selectedNode=s,h.renderNodeProperties(s)},fitView:!0,snapToGrid:!0},React.createElement(a),React.createElement(d),React.createElement(i)))}}ReactDOM.render(React.createElement(p),t)},syncFromWorkload(){if(!this.isUpdating){this.isUpdating=!0;try{this.playbook.workload=JSON.parse(this.workloadEditor.getValue()),this.updateYamlEditor()}catch{}this.isUpdating=!1}},syncFromYaml(){if(!this.isUpdating){this.isUpdating=!0;try{const e=jsyaml.load(this.yamlEditor.getValue());e&&typeof e=="object"&&(this.playbook=e,this.updateWorkloadEditor(),this.updateWorkflowEditor())}catch{}this.isUpdating=!1}},updateYamlEditor(){!this.yamlEditor||this.isUpdating||(this.isUpdating=!0,this.yamlEditor.setValue(jsyaml.dump(this.playbook)),this.isUpdating=!1)},updateWorkloadEditor(){!this.workloadEditor||this.isUpdating||(this.isUpdating=!0,this.workloadEditor.setValue(JSON.stringify(this.playbook.workload||{},null,2)),this.isUpdating=!1)},updateWorkflowEditor(){const{nodes:e,edges:t}=this.convertPlaybookToNodesAndEdges(this.playbook);this.reactFlow.setNodes(e),this.reactFlow.setEdges(t)},renderNodeProperties(e){const t=document.getElementById("properties-panel");if(t.innerHTML="",!e){t.innerHTML='<div class="placeholder"><i class="fas fa-mouse-pointer"></i><p>Select a node to view its properties.</p></div>';return}const o=(i,n,l,c="text")=>{const p=document.createElement("div");p.className="ant-form-item";const m=document.createElement("label");m.className="ant-form-item-label",m.htmlFor=n,m.textContent=i;const r=document.createElement(c==="textarea"?"textarea":"input");return r.className="ant-input",r.id=n,r.value=l,c==="textarea"&&(r.rows=3),p.append(m,r),p},a=document.createElement("h4");a.textContent=`${e.data.type.charAt(0).toUpperCase()+e.data.type.slice(1)} Properties`,t.appendChild(a),e.data.type==="step"&&(t.appendChild(o("Step Name:","prop-step-name",e.data.label)),t.appendChild(o("Description:","prop-step-desc",e.data.desc,"textarea")));const d=document.createElement("button");d.className="ant-btn ant-btn-primary",d.textContent="Update",d.dataset.action="update-node",t.appendChild(d)},updateNodeProperties(){if(!this.selectedNode)return;const{id:e,data:t}=this.selectedNode;if(t.type==="step"){const o=document.getElementById("prop-step-name").value,a=document.getElementById("prop-step-desc").value;this.reactFlow.setNodes(i=>i.map(n=>(n.id===e&&(n.data={...n.data,label:o,desc:a}),n)));const d=this.playbook.workflow.find(i=>i.step===e);d&&(d.step=o,d.desc=a),e!==o&&(this.reactFlow.setEdges(i=>i.map(n=>(n.source===e&&(n.source=o),n.target===e&&(n.target=o),n))),this.selectedNode.id=o)}this.updateYamlEditor()},async savePlaybook(){try{const e=this.yamlEditor.getValue(),t=btoa(unescape(encodeURIComponent(e))),o=await fetch("/catalog/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content_base64:t})});if(!o.ok)throw new Error("Server responded with an error.");const a=await o.json();this.showInfoMessage(`Playbook saved. Path: ${a.path}, Version: ${a.version}`,"success"),window.location.pathname.includes("/new")&&window.history.replaceState({},"",`/editor/${encodeURIComponent(a.path)}/${encodeURIComponent(a.version)}`)}catch(e){this.showInfoMessage(`Error saving playbook: ${e.message}`,"error")}},loadPlaybookFromURL(){const e=window.location.pathname.split("/");if(e.length>=3&&(e[1]==="editor"||e[1]==="playbook")&&e[2]!=="new"){const t=decodeURIComponent(e[2]),o=e.length>=4?decodeURIComponent(e[3]):"latest";this.loadPlaybook(t,o)}},async loadPlaybook(e,t){try{const o=await fetch(`/catalog/${encodeURIComponent(e)}/${encodeURIComponent(t)}`);if(!o.ok)throw new Error("Playbook not found or server error.");const a=await o.json();if(!a.content)throw new Error("Playbook content is empty.");this.playbook=jsyaml.load(a.content),document.getElementById("editor-title").textContent=`Editing: ${this.playbook.name||e}`,this.updateAllEditors()}catch(o){this.showInfoMessage(`Error loading playbook: ${o.message}`,"error")}},updateAllEditors(){this.isUpdating=!0,this.updateYamlEditor(),this.updateWorkloadEditor(),this.updateWorkflowEditor(),this.isUpdating=!1},showInfoMessage(e,t="info"){const o=document.getElementById("info-panel"),a=document.getElementById("info-message");!o||!a||(a.textContent=e,o.className=`ant-alert ant-alert-${t} ant-alert-with-description ant-alert-closable`,o.style.display="flex")},hideInfoMessage(){const e=document.getElementById("info-panel");e&&(e.style.display="none")},convertPlaybookToNodesAndEdges(e){const t=[],o=[];return!e.workflow||!Array.isArray(e.workflow)?{nodes:t,edges:o}:(e.workflow.forEach((a,d)=>{t.push({id:a.step,type:"default",position:{x:250,y:d*150},data:{label:a.step,desc:a.desc||"",type:"step",config:a},className:"node node-step"}),a.next&&Array.isArray(a.next)&&a.next.forEach((i,n)=>{i.then&&Array.isArray(i.then)&&i.then.forEach((l,c)=>{o.push({id:`${a.step}-${l}-${n}-${c}`,source:a.step,target:l,label:i.when||"next"})})})}),{nodes:t,edges:o})}};document.addEventListener("DOMContentLoaded",()=>{h.init()});
