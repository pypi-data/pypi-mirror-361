Metadata-Version: 2.4
Name: yai-nexus-logger
Version: 0.4.0
Summary: A powerful, structured logger for modern Python applications, with built-in trace_id support for easy request tracking.
Author-email: Harry <harrytang.next@gmail.com>
Project-URL: Homepage, https://github.com/yai-nexus/yai-nexus-logger
Project-URL: Bug Tracker, https://github.com/yai-nexus/yai-nexus-logger/issues
Classifier: Programming Language :: Python :: 3
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Requires-Python: >=3.10
Description-Content-Type: text/markdown
License-File: LICENSE
Provides-Extra: dev
Requires-Dist: pytest; extra == "dev"
Requires-Dist: pytest-cov; extra == "dev"
Requires-Dist: pytest-mock; extra == "dev"
Requires-Dist: ruff==0.12.1; extra == "dev"
Requires-Dist: fastapi; extra == "dev"
Requires-Dist: uvicorn[standard]; extra == "dev"
Requires-Dist: httpx; extra == "dev"
Requires-Dist: python-dotenv; extra == "dev"
Provides-Extra: sls
Requires-Dist: aliyun-log-python-sdk>=0.6.45; extra == "sls"
Dynamic: license-file

# YAI Nexus Logger

[![PyPI version](https://badge.fury.io/py/yai-nexus-logger.svg)](https://badge.fury.io/py/yai-nexus-logger)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

YAI Nexus Logger æ˜¯ä¸€ä¸ªä¸ºç°ä»£ Python åº”ç”¨è®¾è®¡çš„ã€åŠŸèƒ½å¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„æ—¥å¿—è®°å½•å·¥å…·ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çš„ç¨‹åºå°±åƒä¸€ä¸ªç¹å¿™çš„å¨æˆ¿ï¼Œæ—¥å¿—å°±æ˜¯å¨æˆ¿é‡Œå‘ç”Ÿæ‰€æœ‰äº‹æƒ…çš„è®°å½•æœ¬ã€‚æ— è®ºæ˜¯è°åœ¨ä»€ä¹ˆæ—¶å€™ç‚’äº†ä»€ä¹ˆèœï¼Œè¿˜æ˜¯ä¸å°å¿ƒæ‰“ç¢äº†ä¸€ä¸ªç›˜å­ï¼Œè¿™ä¸ªè®°å½•æœ¬éƒ½ä¼šè®°ä¸‹æ¥ã€‚è¿™æ ·ï¼Œå½“å‡ºç°é—®é¢˜æ—¶ï¼ˆæ¯”å¦‚å®¢äººæŠ•è¯‰èœå’¸äº†ï¼‰ï¼Œä½ å°±å¯ä»¥ç¿»çœ‹è®°å½•æœ¬ï¼Œå¿«é€Ÿæ‰¾åˆ°æ˜¯å“ªä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜ã€‚

æœ¬å·¥å…·å†…ç½®äº† `trace_id`ï¼ˆè¿½è¸ªIDï¼‰åŠŸèƒ½ï¼Œå®ƒå°±åƒç»™æ¯ä¸ªè®¢å•åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ã€‚æ— è®ºè¿™ä¸ªè®¢å•åœ¨å¨æˆ¿é‡Œç»è¿‡äº†å¤šå°‘é“å·¥åºï¼Œä½ éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªç¼–å·ï¼Œè¿½è¸ªåˆ°å®ƒçš„å…¨éƒ¨è¿‡ç¨‹ã€‚è¿™åœ¨å¤æ‚çš„ç¨‹åºä¸­éå¸¸æœ‰ç”¨ï¼

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

- **ç¯å¢ƒå˜é‡ç»Ÿä¸€é…ç½®**ï¼šåœ¨ç¨‹åºå¯åŠ¨å‰é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ä¸€æ¬¡ï¼Œæ‰€æœ‰åœ°æ–¹å³å¯å¼€ç®±å³ç”¨ã€‚
- **ä¸€é”®è·å– Logger**ï¼šä½¿ç”¨ `get_logger(__name__)` å³å¯è·å¾—ä¸€ä¸ªç»§æ‰¿äº†æ‰€æœ‰é…ç½®çš„ logger å®ä¾‹ï¼Œå¹¶èƒ½è‡ªåŠ¨è¿½è¸ªæ—¥å¿—æ¥æºæ¨¡å—ã€‚
- **ç»“æ„åŒ–æ—¥å¿—**ï¼šé»˜è®¤è¾“å‡ºæ ¼å¼æ¸…æ™°çš„æ—¥å¿—ï¼Œæ–¹ä¾¿ä½ ï¼ˆå’Œæœºå™¨ï¼‰é˜…è¯»ã€‚
- **è‡ªåŠ¨è¿½è¸ªID**ï¼šè‡ªåŠ¨ä¸ºæ¯ä¸€æ¡è¯·æ±‚é“¾è·¯åˆ†é… `trace_id`ï¼Œè®©ä½ è½»æ¾è¿½è¸ªç¨‹åºçš„æ¯ä¸€ä¸ªè§’è½ã€‚
- **ä¸ Uvicorn å®Œç¾é›†æˆ**ï¼šå¼€ç®±å³ç”¨ï¼Œè‡ªåŠ¨æ¥ç®¡ Uvicorn çš„è®¿é—®æ—¥å¿—ï¼Œé£æ ¼ç»Ÿä¸€ã€‚
- **é˜¿é‡Œäº‘SLSæ”¯æŒ**ï¼šå¯ä»¥ç›´æ¥å°†æ—¥å¿—å‘é€åˆ°é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡ï¼Œæ–¹ä¾¿åœ¨äº‘ç«¯è¿›è¡Œæ—¥å¿—åˆ†æå’Œç›‘æ§ã€‚
- **çµæ´»è¾“å‡º**ï¼šå¯ä»¥åŒæ—¶å°†æ—¥å¿—æ‰“å°åœ¨æ§åˆ¶å°ã€ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œä»¥åŠå‘é€åˆ°äº‘æœåŠ¡ã€‚

## ğŸš€ å®‰è£…

```bash
pip install yai-nexus-logger
```

å¦‚æœéœ€è¦å°†æ—¥å¿—å‘é€åˆ°é˜¿é‡Œäº‘SLSï¼Œè¯·å®‰è£…å¸¦æœ‰`sls`ä¾èµ–çš„æ‰©å±•ç‰ˆæœ¬ï¼š
```bash
pip install 'yai-nexus-logger[sls]'
```

## ğŸ¯ å¿«é€Ÿä¸Šæ‰‹

ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºå¦‚ä½•å¿«é€Ÿå¼€å§‹ä½¿ç”¨ï¼š

```python
# main.py
from yai_nexus_logger import init_logging, get_logger

# 1. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
# åœ¨ç¨‹åºå¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡å³å¯ï¼Œé»˜è®¤ä¼šé…ç½®å¥½æ§åˆ¶å°è¾“å‡º
init_logging()

# 2. è·å– logger å®ä¾‹
# æ¨èä½¿ç”¨ __name__ è·å–å®ä¾‹ï¼Œæ—¥å¿—ä¼šè‡ªåŠ¨åŒ…å«æ¨¡å—è·¯å¾„
logger = get_logger(__name__)

# 3. è®°å½•æ—¥å¿—
logger.info("ç¨‹åºå·²å¯åŠ¨")
logger.warning("è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šä¿¡æ¯")
logger.error("å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯", extra={"user_id": 123, "request_id": "abc-xyz"})
```

è¿è¡Œåï¼Œä½ ä¼šåœ¨æ§åˆ¶å°çœ‹åˆ°æ ¼å¼æ¸…æ™°çš„ç»“æ„åŒ–æ—¥å¿—è¾“å‡ºã€‚

## ğŸ”§ é…ç½®

`yai-nexus-logger` æ”¯æŒä¸¤ç§é…ç½®æ–¹å¼ï¼šç¯å¢ƒå˜é‡ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰å’Œä»£ç é…ç½®ï¼ˆæ¨èç”¨äºå¤æ‚åœºæ™¯æˆ–æµ‹è¯•ï¼‰ã€‚

### ç¯å¢ƒå˜é‡é…ç½®

è¿™æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œä½ åªéœ€è¦åœ¨å¯åŠ¨ç¨‹åºå‰è®¾ç½®å¥½ç›¸åº”çš„ç¯å¢ƒå˜é‡å³å¯ã€‚

| ç¯å¢ƒå˜é‡                        | ç±»å‹    | é»˜è®¤å€¼                  | æè¿°                                                               |
| ------------------------------- | ------- | ----------------------- | ------------------------------------------------------------------ |
| `LOG_APP_NAME`                  | `str`   | `app`                   | åº”ç”¨åç§°ï¼Œä¼šä½œä¸ºæ—¥å¿—æ–‡ä»¶åå’ŒSLSæ—¥å¿—æ¥æºçš„ä¸€éƒ¨åˆ†ã€‚                |
| `LOG_LEVEL`                     | `str`   | `INFO`                  | å…¨å±€æ—¥å¿—çº§åˆ« (DEBUG, INFO, WARNING, ERROR, CRITICAL)               |
| `LOG_CONSOLE_ENABLED`           | `bool`  | `true`                  | æ˜¯å¦å¯ç”¨æ§åˆ¶å°è¾“å‡ºã€‚                                               |
| `LOG_FILE_ENABLED`              | `bool`  | `false`                 | æ˜¯å¦å¯ç”¨æ–‡ä»¶è¾“å‡ºã€‚                                                 |
| `LOG_FILE_PATH`                 | `str`   | `logs/{APP_NAME}.log`   | æ—¥å¿—æ–‡ä»¶è·¯å¾„ã€‚                                                     |
| `LOG_UVICORN_INTEGRATION_ENABLED` | `bool`  | `false`                 | æ˜¯å¦è‡ªåŠ¨æ¥ç®¡ Uvicorn çš„ access logã€‚                               |
| `SLS_ENABLED`                   | `bool`  | `false`                 | æ˜¯å¦å¯ç”¨é˜¿é‡Œäº‘SLSè¾“å‡ºã€‚                                            |
| `SLS_ENDPOINT`                  | `str`   | -                       | é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡çš„ Endpoint (ä¾‹å¦‚ `cn-hangzhou.log.aliyuncs.com`)      |
| `SLS_ACCESS_KEY_ID`             | `str`   | -                       | é˜¿é‡Œäº‘ Access Key ID                                               |
| `SLS_ACCESS_KEY_SECRET`         | `str`   | -                       | é˜¿é‡Œäº‘ Access Key Secret                                           |
| `SLS_PROJECT`                   | `str`   | -                       | é˜¿é‡Œäº‘æ—¥å¿—é¡¹ç›®åç§°ã€‚                                               |
| `SLS_LOGSTORE`                  | `str`   | -                       | é˜¿é‡Œäº‘æ—¥å¿—åº“åç§°ã€‚                                                 |
| `SLS_TOPIC`                     | `str`   | `default`               | æ—¥å¿—ä¸»é¢˜ã€‚                                                         |

### ä»£ç é…ç½®

å¦‚æœéœ€è¦æ›´çµæ´»çš„é…ç½®ï¼Œä½ å¯ä»¥ä½¿ç”¨ `LoggerConfigurator`ã€‚

```python
from yai_nexus_logger import LoggerConfigurator, init_logging, get_logger

# ä½¿ç”¨å»ºé€ è€…æ¨¡å¼è¿›è¡Œé“¾å¼é…ç½®
config = (
    LoggerConfigurator(app_name="my-awesome-app", level="DEBUG")
    .with_console_handler()  # æ·»åŠ æ§åˆ¶å°è¾“å‡º
    .with_file_handler(log_path="logs/my_app.log")  # æ·»åŠ æ–‡ä»¶è¾“å‡º
    .with_uvicorn_integration() # å¼€å¯ Uvicorn é›†æˆ
)

# ä½¿ç”¨é…ç½®åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
init_logging(config)

logger = get_logger(__name__)
logger.info("æ—¥å¿—ç³»ç»Ÿå·²é€šè¿‡ä»£ç é…ç½®å®Œæˆï¼")
```

## ğŸ§© é›†æˆç¤ºä¾‹

### ä¸ FastAPI / Uvicorn é›†æˆ

ä¸ºäº†åœ¨ FastAPI åº”ç”¨ä¸­å®ç°å…¨é“¾è·¯çš„ `trace_id` è¿½è¸ªï¼Œå¹¶ç»Ÿä¸€ `access log` æ ¼å¼ï¼Œè¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1.  **å¼€å¯ Uvicorn é›†æˆ**: è®¾ç½®ç¯å¢ƒå˜é‡ `LOG_UVICORN_INTEGRATION_ENABLED=true` æˆ–åœ¨ä»£ç ä¸­è°ƒç”¨ `.with_uvicorn_integration()`ã€‚
2.  **æ·»åŠ ä¸­é—´ä»¶**: åœ¨ FastAPI åº”ç”¨ä¸­æ·»åŠ ä¸€ä¸ªä¸­é—´ä»¶æ¥ç”Ÿæˆå’Œç®¡ç† `trace_id`ã€‚

```python
# fastapi_app.py
import uuid
from fastapi import FastAPI, Request, Response
from yai_nexus_logger import get_logger, init_logging, trace_context

# 1. åœ¨åº”ç”¨å¯åŠ¨å‰åˆå§‹åŒ–æ—¥å¿—
# å‡è®¾å·²è®¾ç½® LOG_UVICORN_INTEGRATION_ENABLED=true
init_logging()

app = FastAPI()
logger = get_logger(__name__)

# 2. æ·»åŠ ä¸­é—´ä»¶ä»¥æ³¨å…¥ trace_id
@app.middleware("http")
async def trace_id_middleware(request: Request, call_next):
    # å°è¯•ä»è¯·æ±‚å¤´è·å– trace_idï¼Œå¦åˆ™ç”Ÿæˆä¸€ä¸ªæ–°çš„
    trace_id = request.headers.get("X-Request-ID", str(uuid.uuid4()))
    
    # å°† trace_id å­˜å…¥ä¸Šä¸‹æ–‡
    token = trace_context.set_trace_id(trace_id)

    response = await call_next(request)
    
    # åœ¨å“åº”å¤´ä¸­è¿”å› trace_id
    response.headers["X-Request-ID"] = trace_id
    
    # æ¸…ç†ä¸Šä¸‹æ–‡
    trace_context.reset_trace_id(token)
    return response

@app.get("/")
async def root():
    logger.info("Hello from the root endpoint!")
    return {"message": "Check your logs and response headers for X-Request-ID."}

# 3. å¯åŠ¨åº”ç”¨
# uvicorn fastapi_app:app --reload
```

ç°åœ¨ï¼Œå½“ä½ è®¿é—® Uvicorn æœåŠ¡æ—¶ï¼Œå®ƒçš„è®¿é—®æ—¥å¿—ä¼šè‡ªåŠ¨å˜æˆç»“æ„åŒ–çš„ JSON æ ¼å¼ï¼Œå¹¶ä¸”åŒ…å« `trace_id`ã€‚ä½ åº”ç”¨å†…çš„æ‰€æœ‰æ—¥å¿—ä¹Ÿä¼šè‡ªåŠ¨é™„å¸¦ç›¸åŒçš„ `trace_id`ã€‚

### ä¸é˜¿é‡Œäº‘ SLS é›†æˆ

1.  **å®‰è£…ä¾èµ–**: `pip install 'yai-nexus-logger[sls]'`
2.  **é…ç½®ç¯å¢ƒå˜é‡**: è®¾ç½®å¥½ `SLS_ENABLED=true` ä»¥åŠå…¶ä»– `SLS_*` ç›¸å…³å˜é‡ã€‚
3.  **åˆå§‹åŒ–æ—¥å¿—**: `init_logging()`

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæ‰€æœ‰æ—¥å¿—å°†è‡ªåŠ¨è¢«å‘é€åˆ°ä½ æŒ‡å®šçš„é˜¿é‡Œäº‘æ—¥å¿—é¡¹ç›®ä¸­ã€‚

## ğŸ§‘â€ğŸ’» æœ¬åœ°å¼€å‘

æˆ‘ä»¬æ¬¢è¿ä»»ä½•å½¢å¼çš„è´¡çŒ®ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤è¿›è¡Œæœ¬åœ°å¼€å‘ï¼š

1.  **å…‹éš†ä»“åº“**
    ```bash
    git clone https://github.com/yai-nexus/yai-nexus-logger.git
    cd yai-nexus-logger
    ```

2.  **åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ**
    ```bash
    python -m venv venv
    source venv/bin/activate  # macOS/Linux
    # venv\Scripts\activate  # Windows
    ```

3.  **å®‰è£…å¼€å‘ä¾èµ–**
    ```bash
    pip install -e '.[dev,sls]'
    ```
    è¿™ä¼šä»¥å¯ç¼–è¾‘æ¨¡å¼å®‰è£…åŒ…ï¼Œå¹¶åŒ…å«æ‰€æœ‰æµ‹è¯•å’Œä»£ç é£æ ¼æ£€æŸ¥æ‰€éœ€çš„ä¾èµ–ã€‚

4.  **è¿è¡Œæµ‹è¯•**
    ```bash
    pytest
    ```

## ğŸ“œ License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.
