<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokyo Traffic Geographic Dashboard - MCP Traffic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
            gap: 0;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
        }

        .station-list {
            list-style: none;
        }

        .station-item {
            background: white;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #ff6b6b;
        }

        .station-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .station-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .station-passengers {
            font-size: 0.9rem;
            color: #666;
        }

        .operator-jr-east { border-left-color: #9ACD32; }
        .operator-tokyometro { border-left-color: #F39700; }

        .map-container {
            position: relative;
            height: 100vh;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .legend-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .time-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-weight: bold;
            color: #333;
        }

        .custom-popup {
            font-family: Arial, sans-serif;
        }

        .popup-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1rem;
        }

        .popup-detail {
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .github-link {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .github-link:hover {
            transform: translateY(-2px);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                max-height: 40vh;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üöÖ Tokyo Traffic</h1>
                <p>Real-time Transportation Dashboard</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-passengers">0</div>
                    <div class="stat-label">Daily Passengers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-trains">0</div>
                    <div class="stat-label">Active Trains</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="average-delay">0</div>
                    <div class="stat-label">Avg Delay (min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-stations">0</div>
                    <div class="stat-label">Stations</div>
                </div>
            </div>

            <div class="section">
                <h3>üèÜ Busiest Stations</h3>
                <ul class="station-list" id="station-list">
                    <!-- Stations will be populated here -->
                </ul>
            </div>

            <div class="section">
                <h3>üìä Data Sources</h3>
                <p style="font-size: 0.85rem; color: #666; line-height: 1.4;">
                    Data collected from ODPT (Open Data Platform for Transportation) API.
                    <br><br>
                    <strong>Sample Analysis:</strong><br>
                    ‚Ä¢ 5 major stations analyzed<br>
                    ‚Ä¢ 2.15M daily passengers<br>
                    ‚Ä¢ 2 active operators<br>
                    ‚Ä¢ Real-time tracking enabled
                </p>
            </div>
        </div>

        <div class="map-container">
            <a href="https://github.com/Tatsuru-Kikuchi/MCP-traffic" target="_blank" class="github-link">
                üìÅ View Repository
            </a>
            <div class="loading-spinner" id="loading">
                <div class="spinner"></div>
            </div>
            <div class="time-display" id="current-time"></div>
            <div id="map"></div>
            <div class="legend">
                <h4>üó∫Ô∏è Map Legend</h4>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #ff6b6b;"></div>
                    <span>Stations (size = passengers)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #4ecdc4;"></div>
                    <span>Active Trains</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #45b7d1;"></div>
                    <span>Active Buses</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #9ACD32;"></div>
                    <span>JR East</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #F39700;"></div>
                    <span>Tokyo Metro</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        class TokyoTrafficDashboard {
            constructor() {
                this.map = null;
                this.stationMarkers = [];
                this.trainMarkers = [];
                this.busMarkers = [];
                this.data = null;
                this.init();
            }

            async init() {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await this.loadData();
                this.initMap();
                this.updateStats();
                this.updateStationList();
                this.addMarkersToMap();
                this.updateTime();
                this.hideLoading();
                
                setInterval(() => this.updateRealTimeData(), 30000);
                setInterval(() => this.updateTime(), 1000);
            }

            async loadData() {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/Tatsuru-Kikuchi/MCP-traffic/main/data/examples/sample_analysis_results.json');
                    const analysisData = await response.json();
                    
                    const stationResponse = await fetch('https://raw.githubusercontent.com/Tatsuru-Kikuchi/MCP-traffic/main/data/examples/sample_station_data.json');
                    const stationData = await stationResponse.json();
                    
                    this.data = {
                        stations: stationData,
                        trains: analysisData.real_time_analysis.active_trains.map(train => ({
                            "@type": "odpt:Train",
                            "owl:sameAs": train.train_id,
                            "odpt:trainNumber": train.train_number,
                            "odpt:railway": `odpt.Railway:${train.operator}.${train.railway}`,
                            "odpt:operator": `odpt.Operator:${train.operator}`,
                            "geo:lat": train.current_position.lat,
                            "geo:long": train.current_position.lng,
                            "odpt:delay": train.delay_minutes
                        })),
                        buses: analysisData.real_time_analysis.active_buses.map(bus => ({
                            "@type": "odpt:Bus",
                            "owl:sameAs": bus.bus_id,
                            "odpt:busNumber": bus.bus_number,
                            "odpt:operator": `odpt.Operator:${bus.operator}`,
                            "geo:lat": bus.current_position.lat,
                            "geo:long": bus.current_position.lng,
                            "odpt:delay": bus.delay_minutes
                        })),
                        analysis: {
                            totalPassengers: analysisData.executive_summary.total_daily_passengers,
                            averagePassengers: Math.round(analysisData.executive_summary.total_daily_passengers / analysisData.executive_summary.analyzed_stations),
                            busiestStations: analysisData.station_analysis.busiest_stations,
                            bounds: {
                                minLat: analysisData.geographic_analysis.coverage_area.bounding_box.south,
                                maxLat: analysisData.geographic_analysis.coverage_area.bounding_box.north,
                                minLng: analysisData.geographic_analysis.coverage_area.bounding_box.west,
                                maxLng: analysisData.geographic_analysis.coverage_area.bounding_box.east
                            },
                            averageDelay: analysisData.real_time_analysis.system_performance.average_delay
                        }
                    };
                } catch (error) {
                    console.warn('Could not load remote data, using fallback:', error);
                    this.loadFallbackData();
                }
            }

            loadFallbackData() {
                this.data = {
                    stations: [
                        {
                            "@type": "odpt:Station",
                            "owl:sameAs": "odpt.Station:JR-East.Yamanote.Tokyo",
                            "dc:title": "Êù±‰∫¨ÈßÖ",
                            "dc:title@en": "Tokyo Station",
                            "odpt:operator": "odpt.Operator:JR-East",
                            "odpt:railway": "odpt.Railway:JR-East.Yamanote",
                            "geo:lat": 35.6812,
                            "geo:long": 139.7671,
                            "odpt:passengerSurvey": [{"odpt:surveyYear": 2022, "odpt:passengerJourneys": 462000}]
                        },
                        {
                            "@type": "odpt:Station",
                            "owl:sameAs": "odpt.Station:JR-East.Yamanote.Shinjuku",
                            "dc:title": "Êñ∞ÂÆøÈßÖ",
                            "dc:title@en": "Shinjuku Station",
                            "odpt:operator": "odpt.Operator:JR-East",
                            "odpt:railway": "odpt.Railway:JR-East.Yamanote",
                            "geo:lat": 35.6896,
                            "geo:long": 139.7006,
                            "odpt:passengerSurvey": [{"odpt:surveyYear": 2022, "odpt:passengerJourneys": 753000}]
                        },
                        {
                            "@type": "odpt:Station",
                            "owl:sameAs": "odpt.Station:TokyoMetro.Ginza.Ginza",
                            "dc:title": "ÈäÄÂ∫ßÈßÖ",
                            "dc:title@en": "Ginza Station",
                            "odpt:operator": "odpt.Operator:TokyoMetro",
                            "odpt:railway": "odpt.Railway:TokyoMetro.Ginza",
                            "geo:lat": 35.6717,
                            "geo:long": 139.7647,
                            "odpt:passengerSurvey": [{"odpt:surveyYear": 2022, "odpt:passengerJourneys": 180000}]
                        }
                    ],
                    trains: [
                        {
                            "@type": "odpt:Train",
                            "odpt:trainNumber": "1001G",
                            "odpt:operator": "odpt.Operator:JR-East",
                            "geo:lat": 35.6850,
                            "geo:long": 139.7400,
                            "odpt:delay": 2
                        }
                    ],
                    buses: [
                        {
                            "@type": "odpt:Bus",
                            "odpt:busNumber": "1234",
                            "odpt:operator": "odpt.Operator:Toei",
                            "geo:lat": 35.6654,
                            "geo:long": 139.7583,
                            "odpt:delay": 1
                        }
                    ],
                    analysis: {
                        totalPassengers: 2151000,
                        busiestStations: [
                            {name_en: "Shinjuku Station", daily_passengers: 753000, operator: "JR-East", coordinates: {lat: 35.6896, lng: 139.7006}},
                            {name_en: "Tokyo Station", daily_passengers: 462000, operator: "JR-East", coordinates: {lat: 35.6812, lng: 139.7671}},
                            {name_en: "Ginza Station", daily_passengers: 180000, operator: "TokyoMetro", coordinates: {lat: 35.6717, lng: 139.7647}}
                        ],
                        averageDelay: 1.5
                    }
                };
            }

            initMap() {
                this.map = L.map('map').setView([35.6762, 139.6503], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);
                this.map.getContainer().style.filter = 'hue-rotate(15deg) saturate(1.2)';
            }

            updateStats() {
                document.getElementById('total-passengers').textContent = 
                    (this.data.analysis.totalPassengers / 1000000).toFixed(1) + 'M';
                document.getElementById('active-trains').textContent = this.data.trains.length;
                document.getElementById('average-delay').textContent = this.data.analysis.averageDelay.toFixed(1);
                document.getElementById('total-stations').textContent = this.data.stations.length;
            }

            updateStationList() {
                const stationList = document.getElementById('station-list');
                stationList.innerHTML = '';

                this.data.analysis.busiestStations.forEach((station, index) => {
                    const li = document.createElement('li');
                    const operatorClass = station.operator.toLowerCase().replace('-', '');
                    li.className = `station-item operator-${operatorClass}`;
                    
                    const stationName = station.name_en || station.name;
                    const passengers = station.daily_passengers || station.passengers;
                    
                    li.innerHTML = `
                        <div class="station-name">${index + 1}. ${stationName}</div>
                        <div class="station-passengers">${(passengers / 1000).toFixed(0)}K passengers/day</div>
                    `;
                    
                    li.addEventListener('click', () => {
                        const coords = station.coordinates || {lat: station.lat, lng: station.lng};
                        this.map.setView([coords.lat, coords.lng], 15);
                    });
                    
                    stationList.appendChild(li);
                });
            }

            addMarkersToMap() {
                this.data.stations.forEach(station => {
                    const passengers = station["odpt:passengerSurvey"][0]["odpt:passengerJourneys"];
                    const radius = Math.max(8, Math.min(25, passengers / 30000));
                    
                    const operator = station["odpt:operator"].split(":")[1];
                    const color = operator === "JR-East" ? "#9ACD32" : "#F39700";
                    
                    const marker = L.circleMarker([station["geo:lat"], station["geo:long"]], {
                        radius: radius,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(this.map);

                    const stationName = station["dc:title@en"] || station["dc:title"];
                    const popupContent = `
                        <div class="custom-popup">
                            <div class="popup-title">${stationName}</div>
                            <div class="popup-detail"><strong>Operator:</strong> ${operator}</div>
                            <div class="popup-detail"><strong>Daily Passengers:</strong> ${passengers.toLocaleString()}</div>
                            <div class="popup-detail"><strong>Coordinates:</strong> ${station["geo:lat"].toFixed(4)}, ${station["geo:long"].toFixed(4)}</div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    this.stationMarkers.push(marker);
                });

                this.data.trains.forEach(train => {
                    const marker = L.circleMarker([train["geo:lat"], train["geo:long"]], {
                        radius: 8,
                        fillColor: '#4ecdc4',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(this.map);

                    const popupContent = `
                        <div class="custom-popup">
                            <div class="popup-title">üöÖ Train ${train["odpt:trainNumber"]}</div>
                            <div class="popup-detail"><strong>Operator:</strong> ${train["odpt:operator"].split(":")[1]}</div>
                            <div class="popup-detail"><strong>Delay:</strong> ${train["odpt:delay"]} minutes</div>
                            <div class="popup-detail"><strong>Status:</strong> ${train["odpt:delay"] === 0 ? "On Time" : "Delayed"}</div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    marker.getElement().classList.add('pulse-animation');
                    this.trainMarkers.push(marker);
                });

                this.data.buses.forEach(bus => {
                    const marker = L.circleMarker([bus["geo:lat"], bus["geo:long"]], {
                        radius: 6,
                        fillColor: '#45b7d1',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(this.map);

                    const popupContent = `
                        <div class="custom-popup">
                            <div class="popup-title">üöå Bus ${bus["odpt:busNumber"]}</div>
                            <div class="popup-detail"><strong>Operator:</strong> ${bus["odpt:operator"].split(":")[1]}</div>
                            <div class="popup-detail"><strong>Delay:</strong> ${bus["odpt:delay"]} minutes</div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    this.busMarkers.push(marker);
                });

                if (this.stationMarkers.length > 0) {
                    const group = new L.featureGroup([...this.stationMarkers, ...this.trainMarkers, ...this.busMarkers]);
                    this.map.fitBounds(group.getBounds().pad(0.1));
                }
            }

            updateRealTimeData() {
                this.trainMarkers.forEach((marker, index) => {
                    const currentPos = marker.getLatLng();
                    const newLat = currentPos.lat + (Math.random() - 0.5) * 0.001;
                    const newLng = currentPos.lng + (Math.random() - 0.5) * 0.001;
                    marker.setLatLng([newLat, newLng]);
                    
                    this.data.trains[index]["odpt:delay"] = Math.floor(Math.random() * 5);
                });

                this.busMarkers.forEach((marker, index) => {
                    const currentPos = marker.getLatLng();
                    const newLat = currentPos.lat + (Math.random() - 0.5) * 0.002;
                    const newLng = currentPos.lng + (Math.random() - 0.5) * 0.002;
                    marker.setLatLng([newLat, newLng]);
                    
                    this.data.buses[index]["odpt:delay"] = Math.floor(Math.random() * 3);
                });

                const totalDelay = this.data.trains.reduce((sum, train) => sum + train["odpt:delay"], 0);
                this.data.analysis.averageDelay = totalDelay / this.data.trains.length;
                
                document.getElementById('average-delay').textContent = this.data.analysis.averageDelay.toFixed(1);
            }

            updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    hour12: false,
                    timeZone: 'Asia/Tokyo'
                });
                document.getElementById('current-time').textContent = `Tokyo Time: ${timeString}`;
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TokyoTrafficDashboard();
        });
    </script>
</body>
</html>