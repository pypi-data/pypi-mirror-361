[1m========================================================================= test session starts =========================================================================[0m
platform darwin -- Python 3.13.5, pytest-8.4.0, pluggy-1.6.0 -- /Users/les/Projects/jinja2-async-environment/.venv/bin/python
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/les/Projects/jinja2-async-environment
configfile: pyproject.toml
plugins: xdist-3.7.0, anyio-4.9.0, timeout-2.4.0, cov-6.2.1, mock-3.14.1, benchmark-5.1.0, asyncio-1.0.0
timeout: 300.0s
timeout method: thread
timeout func_only: False
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
[1mcollecting ... [0m[1mcollected 21 items                                                                                                                                                    [0m

tests/test_environment_additional.py::test_async_yield_from_with_generator_function [32mPASSED[0m[32m                                                                      [  4%][0m
tests/test_environment_additional.py::test_async_yield_from_with_async_generator_function [32mPASSED[0m[32m                                                                [  9%][0m
tests/test_environment_additional.py::test_async_yield_from_with_type_error [32mPASSED[0m[32m                                                                              [ 14%][0m
tests/test_environment_additional.py::test_get_template_async_with_parent [32mPASSED[0m[32m                                                                                [ 19%][0m
tests/test_environment_additional.py::test_select_template_async_with_undefined [32mPASSED[0m[32m                                                                          [ 23%][0m
tests/test_environment_additional.py::test_select_template_async_with_template_object [32mPASSED[0m[32m                                                                    [ 28%][0m
tests/test_environment_additional.py::test_select_template_async_with_parent_and_template_not_found [32mPASSED[0m[32m                                                      [ 33%][0m
tests/test_environment_additional.py::test_get_or_select_template_async_with_undefined [32mPASSED[0m[32m                                                                   [ 38%][0m
tests/test_environment_additional.py::test_get_or_select_template_async_with_template_object [32mPASSED[0m[32m                                                             [ 42%][0m
tests/test_environment_additional.py::test_get_or_select_template_async_with_sequence [32mPASSED[0m[32m                                                                    [ 47%][0m
tests/test_environment_additional.py::test_load_template_async_with_template_object [32mPASSED[0m[32m                                                                      [ 52%][0m
tests/test_environment_additional.py::test_load_template_async_with_string [32mPASSED[0m[32m                                                                               [ 57%][0m
tests/test_environment_additional.py::test_load_template_async_with_sequence [32mPASSED[0m[32m                                                                             [ 61%][0m
tests/test_environment_additional.py::test_load_template_async_with_sequence_all_not_found [32mPASSED[0m[32m                                                               [ 66%][0m
tests/test_environment_additional.py::test_get_template_async_no_loader [32mPASSED[0m[32m                                                                                  [ 71%][0m
tests/test_environment_additional.py::test_get_template_async_with_cache_hit [32mPASSED[0m[32m                                                                             [ 76%][0m
tests/test_environment_additional.py::test_get_template_async_with_cache_hit_and_async_is_up_to_date [32mPASSED[0m[32m                                                     [ 80%][0m
tests/test_environment_additional.py::test_get_template_async_with_cache_hit_and_auto_reload_false [32mPASSED[0m[33m                                                       [ 85%][0m
tests/test_environment_additional.py::test_get_template_async_with_cache_hit_and_globals [32mPASSED[0m[33m                                                                 [ 90%][0m
tests/test_environment_additional.py::test_get_template_async_with_cache_miss [31mFAILED[0m[31m                                                                            [ 95%][0m
tests/test_environment_additional.py::test_get_template_async_with_cache_miss_and_globals [31mFAILED[0m[31m                                                                [100%][0m[31m[1m
ERROR: Coverage failure: total of 29 is less than fail-under=42
[0m

============================================================================== FAILURES ===============================================================================
[31m[1m_______________________________________________________________ test_get_template_async_with_cache_miss _______________________________________________________________[0m

async_env = <jinja2_async_environment.environment.AsyncEnvironment object at 0x102b22990>

    [0m[37m@pytest[39;49;00m.mark.asyncio[90m[39;49;00m
    [94masync[39;49;00m [94mdef[39;49;00m[90m [39;49;00m[92mtest_get_template_async_with_cache_miss[39;49;00m(async_env: AsyncEnvironment) -> [94mNone[39;49;00m:[90m[39;49;00m
    [90m    [39;49;00m[33m"""Test _get_template_async with a cache miss."""[39;49;00m[90m[39;49;00m
        [90m# Set up the environment[39;49;00m[90m[39;49;00m
        loader = MagicMock()[90m[39;49;00m
        async_env.loader = loader[90m[39;49;00m
        async_env.cache = {}[90m[39;49;00m
    [90m[39;49;00m
        [90m# Create a template[39;49;00m[90m[39;49;00m
        template = MagicMock()[90m[39;49;00m
    [90m[39;49;00m
        [90m# Mock the loader.load_async method[39;49;00m[90m[39;49;00m
        loader.load_async = AsyncMock(return_value=template)[90m[39;49;00m
    [90m[39;49;00m
        [90m# Call _get_template_async[39;49;00m[90m[39;49;00m
        result = [94mawait[39;49;00m async_env._get_template_async([33m"[39;49;00m[33mtemplate.html[39;49;00m[33m"[39;49;00m, [94mNone[39;49;00m)[90m[39;49;00m
    [90m[39;49;00m
        [90m# Verify the result and that load_async was called[39;49;00m[90m[39;49;00m
>       [94massert[39;49;00m result [95mis[39;49;00m template[90m[39;49;00m
[1m[31mE       AssertionError: assert <MagicMock id='4341289648'> is <MagicMock id='4341290320'>[0m

[1m[31mtests/test_environment_additional.py[0m:373: AssertionError
[31m[1m_________________________________________________________ test_get_template_async_with_cache_miss_and_globals _________________________________________________________[0m

async_env = <jinja2_async_environment.environment.AsyncEnvironment object at 0x102c347d0>

    [0m[37m@pytest[39;49;00m.mark.asyncio[90m[39;49;00m
    [94masync[39;49;00m [94mdef[39;49;00m[90m [39;49;00m[92mtest_get_template_async_with_cache_miss_and_globals[39;49;00m(async_env: AsyncEnvironment) -> [94mNone[39;49;00m:[90m[39;49;00m
    [90m    [39;49;00m[33m"""Test _get_template_async with a cache miss and globals."""[39;49;00m[90m[39;49;00m
        [90m# Set up the environment[39;49;00m[90m[39;49;00m
        loader = MagicMock()[90m[39;49;00m
        async_env.loader = loader[90m[39;49;00m
        async_env.cache = {}[90m[39;49;00m
    [90m[39;49;00m
        [90m# Create a template[39;49;00m[90m[39;49;00m
        template = MagicMock()[90m[39;49;00m
    [90m[39;49;00m
        [90m# Mock the loader.load_async method[39;49;00m[90m[39;49;00m
        loader.load_async = AsyncMock(return_value=template)[90m[39;49;00m
    [90m[39;49;00m
        [90m# Mock the make_globals method[39;49;00m[90m[39;49;00m
        globals_dict = {[33m"[39;49;00m[33mvar1[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mvalue1[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mvar2[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mvalue2[39;49;00m[33m"[39;49;00m}[90m[39;49;00m
        processed_globals = {[33m"[39;49;00m[33mvar1[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mprocessed1[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mvar2[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mprocessed2[39;49;00m[33m"[39;49;00m}[90m[39;49;00m
        async_env.make_globals = MagicMock(return_value=processed_globals)[90m[39;49;00m
    [90m[39;49;00m
        [90m# Call _get_template_async with globals[39;49;00m[90m[39;49;00m
        result = [94mawait[39;49;00m async_env._get_template_async([33m"[39;49;00m[33mtemplate.html[39;49;00m[33m"[39;49;00m, globals_dict)[90m[39;49;00m
    [90m[39;49;00m
        [90m# Verify the result and that load_async was called with processed globals[39;49;00m[90m[39;49;00m
>       [94massert[39;49;00m result [95mis[39;49;00m template[90m[39;49;00m
[1m[31mE       AssertionError: assert <MagicMock id='4341294016'> is <MagicMock id='4341292672'>[0m

[1m[31mtests/test_environment_additional.py[0m:404: AssertionError
[33m========================================================================== warnings summary ===========================================================================[0m
tests/test_environment_additional.py::test_get_template_async_with_cache_hit_and_async_is_up_to_date
  /Users/les/Projects/jinja2-async-environment/tests/test_environment_additional.py:297: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    result = await async_env._get_template_async("template.html", None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================================================================== tests coverage ============================================================================
__________________________________________________________ coverage: platform darwin, python 3.13.5-final-0 ___________________________________________________________

Name                                      Stmts   Miss  Cover
-------------------------------------------------------------
jinja2_async_environment/bccache.py          56     29    48%
jinja2_async_environment/compiler.py        393    334    15%
jinja2_async_environment/environment.py     142     36    75%
jinja2_async_environment/loaders.py         320    252    21%
-------------------------------------------------------------
TOTAL                                       911    651    29%
[31m[1mFAIL Required test coverage of 42% not reached. Total coverage: 28.54%
[0m[36m[1m======================================================================= short test summary info =======================================================================[0m
[31mFAILED[0m tests/test_environment_additional.py::[1mtest_get_template_async_with_cache_miss[0m - AssertionError: assert <MagicMock id='4341289648'> is <MagicMock id='4341290320'>
[31mFAILED[0m tests/test_environment_additional.py::[1mtest_get_template_async_with_cache_miss_and_globals[0m - AssertionError: assert <MagicMock id='4341294016'> is <MagicMock id='4341292672'>
[31m=============================================================== [31m[1m2 failed[0m, [32m19 passed[0m, [33m1 warning[0m[31m in 0.61s[0m[31m ===============================================================[0m
