Metadata-Version: 2.4
Name: sskw-tasks
Version: 0.4.2
Summary: sskw shared celery task declaration
Author-email: liwei <491520313@qq.com>
License-Expression: MIT
Project-URL: Homepage, https://tasks.sensearray.com/docs
Requires-Python: >=3.8
Description-Content-Type: text/markdown
Requires-Dist: celery>=5.5.3
Requires-Dist: pydantic>=2.10.6

# SSKW Tasks - å…±äº«Celeryä»»åŠ¡å£°æ˜åŒ…

## é¡¹ç›®ç®€ä»‹

`sskw-tasks` æ˜¯ä¸€ä¸ªå…±äº«çš„PythonåŒ…ï¼Œç”¨äºå®šä¹‰å’Œç®¡ç†Celeryä»»åŠ¡æ¥å£ã€‚è¯¥åŒ…æä¾›äº†ç»Ÿä¸€çš„ä»»åŠ¡å£°æ˜è§„èŒƒï¼Œä½¿å¾—ä¸šåŠ¡ç«¯å’ŒWorkerç«¯å¯ä»¥åŸºäºç›¸åŒçš„æ¥å£å®šä¹‰è¿›è¡Œä»»åŠ¡æŠ•é€’å’Œå…·ä½“å®ç°ã€‚

## ç‰¹æ€§

- ğŸ”„ ç»Ÿä¸€çš„ä»»åŠ¡æ¥å£å£°æ˜
- ğŸ“‹ åŸºäºPydanticçš„æ•°æ®æ¨¡å‹éªŒè¯
- ğŸ”§ çµæ´»çš„Celeryé…ç½®
- ğŸ“¦ æ˜“äºé›†æˆå’Œæ‰©å±•

## å®‰è£…

```bash
pip install sskw-tasks
```

## ç¯å¢ƒé…ç½®

åœ¨ä½¿ç”¨å‰ï¼Œéœ€è¦è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```bash
# Redis/RabbitMQ ä½œä¸ºæ¶ˆæ¯ä»£ç†
export CELERY_BROKER_URL="redis://localhost:6379/0"
# ç»“æœå­˜å‚¨åç«¯
export CELERY_RESULT_BACKEND="redis://localhost:6379/0"
```

## ä¸šåŠ¡ç«¯ä½¿ç”¨æ–¹æ³•

ä¸šåŠ¡ç«¯è´Ÿè´£æŠ•é€’ä»»åŠ¡åˆ°é˜Ÿåˆ—ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ï¼š

### 1. å¯¼å…¥å’Œé…ç½®

```python
from sskw.tasks.celery_app import app
from sskw.tasks.models import AudioTranscriptionRequest, AudioFormatConversionRequest
from sskw.tasks.audio_transcription import audio_transcription_paraformer_cpu

# é…ç½®Celeryï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦è‡ªå®šä¹‰é…ç½®ï¼‰
app.conf.update(
    task_serializer='json',
    result_serializer='json',
    accept_content=['json'],
    result_expires=3600,
)
```

### 2. æŠ•é€’ä»»åŠ¡

```python
# æ„é€ è¾“å…¥æ•°æ®
input_data = AudioTranscriptionRequest(
    audio_urls=[
        "https://example.com/audio1.wav",
        "https://example.com/audio2.wav"
    ],
    data_id="meeting_20250109_001"
)

# å¼‚æ­¥æŠ•é€’ä»»åŠ¡
result = audio_transcription_paraformer_cpu.delay(input_data.model_dump())

# è·å–ä»»åŠ¡ID
task_id = result.id
print(f"ä»»åŠ¡å·²æŠ•é€’ï¼ŒID: {task_id}")

# è·å–ä»»åŠ¡ç»“æœï¼ˆé˜»å¡ï¼‰
try:
    task_result = result.get(timeout=300)
    print(f"ä»»åŠ¡å®Œæˆï¼Œç»“æœ: {task_result}")
except Exception as e:
    print(f"ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {e}")
```

### 3. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€

```python
# æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
status = result.status
print(f"ä»»åŠ¡çŠ¶æ€: {status}")

# éé˜»å¡è·å–ç»“æœ
if result.ready():
    if result.successful():
        print(f"ä»»åŠ¡æˆåŠŸ: {result.result}")
    else:
        print(f"ä»»åŠ¡å¤±è´¥: {result.traceback}")
```

## Workerç«¯ä½¿ç”¨æ–¹æ³•

Workerç«¯è´Ÿè´£å®ç°å…·ä½“çš„ä»»åŠ¡é€»è¾‘ï¼š

### 1. å®ç°ä»»åŠ¡

æ ¹æ®æ˜¯å¦éœ€è¦ä»»åŠ¡å®ä¾‹åŠŸèƒ½ï¼Œæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š

#### æ–¹å¼ä¸€ï¼šç®€å•å®ç°ï¼ˆä¸éœ€è¦ selfï¼‰

```python
# worker_implementation.py
from sskw.tasks.celery_app import app
from sskw.tasks.models import AudioTranscriptionRequest, AudioTranscriptionResult

@app.task(name="audio.transcription.paraformer.cpu")
def audio_transcription_paraformer_cpu_impl(input_data: dict) -> dict:
    """
    éŸ³é¢‘è½¬å½•ä»»åŠ¡çš„ç®€å•å®ç°

    å‚æ•°:
    - input_data (dict): è¾“å…¥æ•°æ®å­—å…¸

    è¿”å›:
    - dict: å¤„ç†ç»“æœ
    """
    # éªŒè¯è¾“å…¥æ•°æ®
    audio_input = AudioTranscriptionRequest(**input_data)

    # æ‰§è¡Œå…·ä½“çš„éŸ³é¢‘è½¬å½•é€»è¾‘
    segments = []
    for i, audio_url in enumerate(audio_input.audio_urls):
        # ç¤ºä¾‹è½¬å½•é€»è¾‘ï¼ˆå®é™…åº”è°ƒç”¨ paraformer æ¨¡å‹ï¼‰
        segment = {
            "text": f"è¿™æ˜¯ç¬¬{i+1}æ®µéŸ³é¢‘çš„è½¬å½•ç»“æœ",
            "start": str(i * 10),
            "end": str((i + 1) * 10)
        }
        segments.append(segment)

    # æ„é€ è¿”å›ç»“æœ
    result = AudioTranscriptionResult(
        audio_urls=audio_input.audio_urls,
        data_id=audio_input.data_id,
        segments=segments,
        merged_audio_url="https://example.com/merged_audio.wav"
    )

    return result.model_dump()
```

#### æ–¹å¼äºŒï¼šé«˜çº§å®ç°ï¼ˆéœ€è¦ selfï¼Œæ”¯æŒçŠ¶æ€æ›´æ–°ï¼‰

```python
# worker_implementation.py
from sskw.tasks.celery_app import app
from sskw.tasks.models import AudioTranscriptionRequest, AudioTranscriptionResult

@app.task(bind=True, name="audio.transcription.paraformer.cpu")
def audio_transcription_paraformer_cpu_impl(self, input_data: dict) -> dict:
    """
    éŸ³é¢‘è½¬å½•ä»»åŠ¡çš„é«˜çº§å®ç°ï¼ˆæ”¯æŒè¿›åº¦æ›´æ–°å’Œé”™è¯¯å¤„ç†ï¼‰

    å‚æ•°:
    - self: ä»»åŠ¡å®ä¾‹ï¼Œæä¾›çŠ¶æ€æ›´æ–°ç­‰åŠŸèƒ½
    - input_data (dict): è¾“å…¥æ•°æ®å­—å…¸

    è¿”å›:
    - dict: å¤„ç†ç»“æœ
    """
    try:
        # éªŒè¯è¾“å…¥æ•°æ®
        audio_input = AudioTranscriptionRequest(**input_data)

        # æ‰§è¡Œå…·ä½“çš„éŸ³é¢‘è½¬å½•é€»è¾‘
        segments = []
        total_audios = len(audio_input.audio_urls)

        for i, audio_url in enumerate(audio_input.audio_urls):
            # ç¤ºä¾‹è½¬å½•é€»è¾‘ï¼ˆå®é™…åº”è°ƒç”¨ paraformer æ¨¡å‹ï¼‰
            segment = {
                "text": f"è¿™æ˜¯ç¬¬{i+1}æ®µéŸ³é¢‘çš„è½¬å½•ç»“æœ",
                "start": str(i * 10),
                "end": str((i + 1) * 10)
            }
            segments.append(segment)

            # æ›´æ–°ä»»åŠ¡è¿›åº¦ï¼ˆå¯é€‰ï¼‰
            self.update_state(
                state='PROGRESS',
                meta={
                    'processed': i + 1,
                    'total': total_audios,
                    'percentage': int((i + 1) / total_audios * 100)
                }
            )

        # æ„é€ è¿”å›ç»“æœ
        result = AudioTranscriptionResult(
            audio_urls=audio_input.audio_urls,
            data_id=audio_input.data_id,
            segments=segments,
            merged_audio_url="https://example.com/merged_audio.wav"
        )

        return result.model_dump()
        
    except Exception as e:
        # è®°å½•é”™è¯¯å¹¶é‡æ–°æŠ›å‡º
        self.update_state(
            state='FAILURE',
            meta={'error': str(e), 'task_id': self.request.id}
        )
        raise
```

#### é€‰æ‹©å“ªç§æ–¹å¼ï¼Ÿ

- **æ–¹å¼ä¸€ï¼ˆä¸å¸¦ selfï¼‰**ï¼šé€‚ç”¨äºç®€å•ä»»åŠ¡ï¼Œä¸éœ€è¦è¿›åº¦æ›´æ–°ã€çŠ¶æ€ç®¡ç†ç­‰åŠŸèƒ½
- **æ–¹å¼äºŒï¼ˆå¸¦ selfï¼‰**ï¼šé€‚ç”¨äºå¤æ‚ä»»åŠ¡ï¼Œéœ€è¦ï¼š
  - è¿›åº¦æ›´æ–° (`self.update_state()`)
  - æ‰‹åŠ¨é‡è¯• (`self.retry()`)
  - è®¿é—®ä»»åŠ¡ä¿¡æ¯ (`self.request.id`, `self.request.retries`)
  - ä»»åŠ¡æ›¿æ¢ (`self.replace()`)

#### self å‚æ•°æä¾›çš„åŠŸèƒ½

```python
# ä»»åŠ¡é‡è¯•
@app.task(bind=True, autoretry_for=(Exception,))
def retry_task(self, data):
    try:
        # ä»»åŠ¡é€»è¾‘
        pass
    except SomeException as e:
        # æ‰‹åŠ¨é‡è¯•
        raise self.retry(countdown=60, max_retries=3)

# è®¿é—®ä»»åŠ¡ä¿¡æ¯
@app.task(bind=True)
def info_task(self, data):
    task_id = self.request.id
    retries = self.request.retries
    print(f"ä»»åŠ¡ID: {task_id}, é‡è¯•æ¬¡æ•°: {retries}")
```

### 2. å¯åŠ¨Worker

```python
# worker.py
from celery import Celery
from sskw.tasks.celery_app import app

# å¯¼å…¥å…·ä½“å®ç°
import worker_implementation

if __name__ == '__main__':
    # å¯åŠ¨worker
    app.start(['worker', '--loglevel=info'])
```

æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œå¯åŠ¨ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
celery -A sskw.tasks.celery_app worker --loglevel=info --concurrency=4
```

## æ‰©å±•ä»»åŠ¡ç±»å‹

å¯ä»¥è½»æ¾æ‰©å±•æ–°çš„ä»»åŠ¡ç±»å‹ï¼š

### 1. å®šä¹‰æ–°çš„æ•°æ®æ¨¡å‹

```python
# åœ¨models.pyä¸­æ·»åŠ 
class ImageInput(BaseModel):
    image_url: str
    operations: List[str]
    quality: int = 80
```

### 2. å£°æ˜æ–°çš„ä»»åŠ¡æ¥å£

```python
# åˆ›å»ºtasks/image_processing.py
from sskw.tasks.celery_app import app
from sskw.tasks.models import ImageInput

@app.task(name="image.process")
def process_image(input: ImageInput) -> dict:
    """
    å›¾åƒå¤„ç†ä»»åŠ¡æ¥å£
    
    å‚æ•°:
    - input (ImageInput): å›¾åƒå¤„ç†è¾“å…¥
    
    è¿”å›:
    - dict: å¤„ç†ç»“æœ
    """
    raise NotImplementedError("æ­¤ä»»åŠ¡å¿…é¡»åœ¨å…·ä½“å®ç°ä¸­å®Œæˆ")
```

### ä»»åŠ¡é‡è¯•é…ç½®

```python
@app.task(bind=True, autoretry_for=(Exception,), retry_kwargs={'max_retries': 3, 'countdown': 60})
def robust_task(self, input_data):
    # ä»»åŠ¡å®ç°
    pass
```

## ç›‘æ§å’Œç®¡ç†

### ä½¿ç”¨Flowerç›‘æ§

```bash
# å®‰è£…flower
pip install flower

# å¯åŠ¨ç›‘æ§ç•Œé¢
celery -A sskw.tasks.celery_app flower
```

### ä½¿ç”¨Celeryå‘½ä»¤è¡Œå·¥å…·

```bash
# æŸ¥çœ‹æ´»è·ƒä»»åŠ¡
celery -A sskw.tasks.celery_app inspect active

# æŸ¥çœ‹workerçŠ¶æ€
celery -A sskw.tasks.celery_app inspect stats

# æ¸…ç©ºé˜Ÿåˆ—
celery -A sskw.tasks.celery_app purge
```

## æœ€ä½³å®è·µ

1. **æ•°æ®éªŒè¯**: å§‹ç»ˆä½¿ç”¨Pydanticæ¨¡å‹éªŒè¯è¾“å…¥æ•°æ®
2. **é”™è¯¯å¤„ç†**: åœ¨ä»»åŠ¡å®ç°ä¸­æ·»åŠ é€‚å½“çš„å¼‚å¸¸å¤„ç†
3. **è¿›åº¦æ›´æ–°**: å¯¹äºé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œå®šæœŸæ›´æ–°è¿›åº¦çŠ¶æ€
4. **èµ„æºç®¡ç†**: åˆç†è®¾ç½®Workerå¹¶å‘æ•°å’Œå†…å­˜é™åˆ¶
5. **ç›‘æ§æ—¥å¿—**: é…ç½®è¯¦ç»†çš„æ—¥å¿—è®°å½•ç”¨äºé—®é¢˜æ’æŸ¥

## ç‰ˆæœ¬ä¿¡æ¯

- å½“å‰ç‰ˆæœ¬: 0.0.1
- Pythonè¦æ±‚: >= 3.8
- Celeryç‰ˆæœ¬: >= 5.5.3

---


## ä¿®æ”¹å†å²
### v0.4.2  2025-07-10 liwei
- æ·»åŠ  meeting.text.refine / meeting.text.summery æ¥å£

### v0.4.1  2025-07-08 liwei
- æ·»åŠ  audio.transcription.paraformer / audio.transcription.sensevoice æ¥å£

### v0.4.0  2025-07-08 liwei   
- æ·»åŠ è¯­éŸ³è½¬æ–‡å­—ä»»åŠ¡ audio.transcription.paraformer.cpu / gpu  audio.transcription.sensevoice.cpu /gpu
- æ·»åŠ è¯­éŸ³æ ¼å¼è½¬æ¢ä»»åŠ¡ audio.format.conversion
